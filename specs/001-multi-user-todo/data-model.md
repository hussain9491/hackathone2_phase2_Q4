# Data Model: Multi-User Todo Web Application

**Date**: 2026-01-06
**Feature**: [spec.md](spec.md)
**Input**: Functional requirements and entity definitions from specification

## Entities

### User

Represents application user account with authentication credentials and metadata.

**Purpose**: Enable user authentication and task ownership

**Fields**:

| Field | Type | Constraints | Purpose |
|--------|--------|--------------|---------|
| id | string (UUID) | Primary key, auto-generated | Unique user identifier |
| email | string | Required, unique, max 255 chars, email format validation | User login credential |
| password_hash | string | Required, bcrypt hashed (cost 12) | Secure password storage |
| created_at | datetime | Required, auto-generated on creation | Account creation timestamp |
| updated_at | datetime | Required, auto-updated on any change | Last modification timestamp |

**Relationships**:
- Has many Tasks (user.id ← tasks.user_id)
- Cascade deletion: Deleting user removes all associated tasks

**Validation Rules**:
- Email format: Standard email validation regex
- Password: Minimum 8 characters (before hashing)
- Email uniqueness: No duplicate emails allowed
- ID: UUID format (generated by database)

---

### Task

Represents todo item belonging to specific user with completion status and timestamps.

**Purpose**: Enable personal task management with creation, modification, and completion tracking

**Fields**:

| Field | Type | Constraints | Purpose |
|--------|--------|--------------|---------|
| id | string (UUID) | Primary key, auto-generated | Unique task identifier |
| user_id | string (UUID) | Required, foreign key → users.id | Owner of task (enforces isolation) |
| title | string | Required, 1-200 characters | Task name/summary |
| description | string (text) | Optional, 0-1000 characters | Detailed task information |
| completed | boolean | Required, default false | Task completion status |
| created_at | datetime | Required, auto-generated on creation | Task creation timestamp |
| updated_at | datetime | Required, auto-updated on any change | Last modification timestamp |

**Relationships**:
- Belongs to User (task.user_id → user.id)
- Cascade deletion: Deleting user removes all tasks

**Validation Rules**:
- Title: Required, 1-200 characters
- Description: Optional, max 1000 characters
- user_id: Must reference existing user (foreign key)
- Completed: Boolean flag for toggle status
- Maximum 1000 tasks per user (application-level constraint)

---

### Session

Represents user authentication state with JWT token.

**Purpose**: Enable stateless authentication across frontend and backend

**Fields** (from JWT token claims):

| Field | Type | Constraints | Purpose |
|--------|--------|--------------|---------|
| sub (user_id) | string (UUID) | Required | Unique user identifier from user.id |
| email | string | Required, max 255 chars | User email from user.email |
| exp | integer (timestamp) | Required | Token expiration time (7 days from iat) |
| iat | integer (timestamp) | Required | Token issued at time |

**Note**: Session is ephemeral - stored in JWT token, not database table.

---

## Schema Relationships

```
┌─────────────────┐
│      User       │
└────────┬────────┘
         │ 1
         │
         │ many
┌────────▼────────┐
│      Task       │
└─────────────────┘

User.id (PK)
    ↓
Task.user_id (FK)
```

**Relationship Details**:
- One user has many tasks (1:N)
- Task must have exactly one owner (N:1)
- Foreign key enforces referential integrity
- Cascade deletion: user removed → all tasks removed
- No orphaned tasks possible

---

## Database Constraints

### Foreign Keys

| Constraint | Table(s) | Enforced Rule |
|------------|-------------|----------------|
| tasks_user_id_fkey | tasks | task.user_id must reference valid user.id |
| users_email_key | users | user.email must be unique |

### Indexes

| Index | Table(s) | Columns | Purpose |
|--------|-------------|----------|---------|
| tasks_user_id_idx | tasks | user_id | Fast filtering by user |
| tasks_created_at_idx | tasks | created_at DESC | Ordering by newest first |
| tasks_user_id_created_idx | tasks | user_id, created_at DESC | Combined user list + ordering |

### Cascade Rules

| Parent | Child | Action on Parent Delete |
|--------|--------|------------------------|
| User | Task | CASCADE (all tasks deleted) |

---

## State Transitions

### Task Completion

```
[Pending] ─────► [Completed]
     │             │
     ◄─────────────┘
     (Toggle)
```

- Task starts as `completed = false` (Pending)
- User can toggle between Pending and Completed multiple times
- Each toggle updates `updated_at` timestamp
- Visual distinction: Completed tasks show strikethrough + 60% opacity

---

## Data Integrity Rules

### Uniqueness

- User emails must be unique across entire database
- Task IDs must be unique across entire database

### Referential Integrity

- Every task.user_id must reference an existing user.id
- Foreign key constraint prevents orphaned tasks

### Consistency

- All timestamp fields auto-managed (created_at on insert, updated_at on update)
- Cascade deletion prevents data inconsistency
- Transactions ensure atomic operations (create user + initial task, delete user + all tasks)

### Validation

- Email format validated before database insertion
- Password length validated before hashing
- Task title length validated before insertion
- Task description length validated before insertion
- User task count validated (<1000) before creation

---

## Performance Considerations

### Query Patterns

| Query | Strategy | Expected Performance |
|--------|-----------|----------------------|
| Get user's tasks | Index on user_id + created_at | <100ms for 100 tasks |
| Get single task | Primary key (task.id) | <10ms |
| Create task | Single insert with foreign key validation | <50ms |
| Update task | Primary key lookup + update | <50ms |
| Delete task | Primary key lookup + delete | <50ms |
| Toggle completion | Primary key lookup + update | <50ms |

### Anti-Patterns

- **N+1 Queries**: Fetch user, then fetch tasks → **SINGLE QUERY** with join/filter
- **Separate Count Query**: Count tasks first, then fetch → **Pagination with LIMIT/OFFSET** if needed
- **Eager Loading**: Fetch all tasks at once → **Lazy load** only when needed
- **Missing Indexes**: Query without user_id index → **Create indexes** for filtering

---

## Migration Notes

### Initial Schema Creation

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    completed BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX tasks_user_id_idx ON tasks(user_id);
CREATE INDEX tasks_created_at_idx ON tasks(created_at DESC);
CREATE INDEX tasks_user_id_created_idx ON tasks(user_id, created_at DESC);
```

### ORM Mapping (SQLModel)

```python
# User model
class UserBase(SQLModel):
    email: str = Field(index=True, max_length=255, unique=True)
    password_hash: str = Field(max_length=255)

class User(UserBase, table=True):
    id: Optional[str] = Field(default=None, primary_key=True)
    created_at: datetime = Field(default_factory=datetime.now)
    updated_at: datetime = Field(default_factory=datetime.now)

# Task model
class TaskBase(SQLModel):
    title: str = Field(max_length=200, index=True)
    description: Optional[str] = Field(default=None, sa_column=Column(Text))
    completed: bool = Field(default=False)

class Task(TaskBase, table=True):
    id: Optional[str] = Field(default=None, primary_key=True)
    user_id: str = Field(foreign_key="user.id", index=True)
    created_at: datetime = Field(default_factory=datetime.now, index=True)
    updated_at: datetime = Field(default_factory=datetime.now)
```

---

## References

- [Research](research.md) - Technical decisions and rationale
- [Specification](spec.md) - Functional requirements
- [Plan](plan.md) - Technical context and architecture
